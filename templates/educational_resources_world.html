{% extends 'base.html' %}

{% block title %}Educational Resources - {{ world.original_filename }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item active">Educational Resources</li>
                        </ol>
                    </nav>
                    <h3><i class="fas fa-graduation-cap"></i> Educational Resources</h3>
                    <p class="text-muted mb-0">Generate teaching materials based on: <strong>{{ world.original_filename }}</strong></p>
                </div>
                <div>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                    <a href="{{ url_for('language_tools_world', unpacked_id=world.id) }}" class="btn btn-outline-primary ms-2">
                        <i class="fas fa-language"></i> Language Tools
                    </a>
                </div>
            </div>

            <!-- Resource Generation Cards -->
            <div class="row">
                <!-- Lesson Plan -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100 border-primary">
                        <div class="card-body text-center">
                            <i class="fas fa-chalkboard-teacher fa-3x text-primary mb-3"></i>
                            <h5 class="card-title">Lesson Plan</h5>
                            <p class="card-text">Generate a comprehensive lesson plan with objectives, activities, and assessment strategies based on the world content.</p>
                            <button class="btn btn-primary" onclick="generateResource('lesson_plan')">
                                <i class="fas fa-file-alt"></i> Generate Lesson Plan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Student Quiz -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100 border-success">
                        <div class="card-body text-center">
                            <i class="fas fa-question-circle fa-3x text-success mb-3"></i>
                            <h5 class="card-title">Student Quiz</h5>
                            <p class="card-text">Create an assessment quiz with multiple choice, true/false, and short answer questions related to the educational content.</p>
                            <button class="btn btn-success" onclick="generateResource('student_quiz')">
                                <i class="fas fa-clipboard-check"></i> Generate Quiz
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Topic Introduction -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100 border-info">
                        <div class="card-body text-center">
                            <i class="fas fa-book-open fa-3x text-info mb-3"></i>
                            <h5 class="card-title">Topic Introduction</h5>
                            <p class="card-text">Create an engaging introduction to help students understand the topic, learning objectives, and key concepts before they start.</p>
                            <button class="btn btn-info" onclick="generateResource('topic_introduction')">
                                <i class="fas fa-play-circle"></i> Generate Introduction
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Parent Letter -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100 border-warning">
                        <div class="card-body text-center">
                            <i class="fas fa-envelope fa-3x text-warning mb-3"></i>
                            <h5 class="card-title">Parent Letter</h5>
                            <p class="card-text">Generate an informative letter for parents explaining the educational value and learning objectives of the Minecraft activity.</p>
                            <button class="btn btn-warning" onclick="generateResource('parent_letter')">
                                <i class="fas fa-paper-plane"></i> Generate Letter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Area -->
            <div id="resultsArea" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-file-text"></i> 
                            <span id="resourceTitle">Generated Resource</span>
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="downloadResource()">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="printResource()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="resourceContent">
                            <!-- Generated content will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Analyzing world content and generating educational resource...</p>
            </div>
        </div>
    </div>
</div>

<script>
let currentResourceData = null;
let currentResourceType = null;

function generateResource(resourceType) {
    // Show loading spinner
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('resultsArea').style.display = 'none';
    
    // Update button states
    const buttons = document.querySelectorAll('button[onclick^="generateResource"]');
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    });
    
    fetch(`/generate_resource/{{ world.id }}/${resourceType}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentResourceData = data.data;
            currentResourceType = resourceType;
            displayResource(data.data, resourceType);
        } else {
            displayError(data.error || 'Failed to generate resource');
        }
    })
    .catch(error => {
        console.error('Error generating resource:', error);
        displayError('Error generating resource. Please try again.');
    })
    .finally(() => {
        // Hide loading spinner and restore buttons
        document.getElementById('loadingSpinner').style.display = 'none';
        buttons.forEach(btn => {
            btn.disabled = false;
            const originalText = btn.getAttribute('data-original') || btn.innerHTML.replace('<i class="fas fa-spinner fa-spin"></i> Generating...', '');
            if (!btn.getAttribute('data-original')) {
                btn.setAttribute('data-original', originalText);
            }
            btn.innerHTML = originalText;
        });
    });
}

function displayResource(data, resourceType) {
    const resourceContent = document.getElementById('resourceContent');
    const resourceTitle = document.getElementById('resourceTitle');
    
    // Set title
    const titles = {
        'lesson_plan': 'Lesson Plan',
        'student_quiz': 'Student Quiz',
        'topic_introduction': 'Topic Introduction',
        'parent_letter': 'Parent Letter'
    };
    resourceTitle.textContent = titles[resourceType] || 'Generated Resource';
    
    // Generate HTML based on resource type
    let html = '';
    
    if (resourceType === 'lesson_plan') {
        html = generateLessonPlanHTML(data);
    } else if (resourceType === 'student_quiz') {
        html = generateQuizHTML(data);
    } else if (resourceType === 'topic_introduction') {
        html = generateIntroductionHTML(data);
    } else if (resourceType === 'parent_letter') {
        html = generateParentLetterHTML(data);
    }
    
    resourceContent.innerHTML = html;
    document.getElementById('resultsArea').style.display = 'block';
    
    // Scroll to results
    document.getElementById('resultsArea').scrollIntoView({ behavior: 'smooth' });
}

function generateLessonPlanHTML(data) {
    let html = `
        <div class="lesson-plan">
            <div class="mb-4">
                <h2 class="text-primary">${data.title}</h2>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <p><strong>Grade Level:</strong> ${data.grade_level}</p>
                        <p><strong>Duration:</strong> ${data.duration}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Subject Areas:</strong> ${data.subject_areas.join(', ')}</p>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <h4><i class="fas fa-bullseye"></i> Learning Objectives</h4>
                <ul>
    `;
    data.learning_objectives.forEach(obj => {
        html += `<li>${obj}</li>`;
    });
    html += `
                </ul>
            </div>
            
            <div class="mb-4">
                <h4><i class="fas fa-tools"></i> Materials Needed</h4>
                <ul>
    `;
    data.materials_needed.forEach(material => {
        html += `<li>${material}</li>`;
    });
    html += `
                </ul>
            </div>
            
            <div class="mb-4">
                <h4><i class="fas fa-clock"></i> Lesson Structure</h4>
    `;
    
    Object.entries(data.lesson_structure).forEach(([phase, details]) => {
        html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">${phase.charAt(0).toUpperCase() + phase.slice(1).replace('_', ' ')} (${details.time})</h5>
                    </div>
                    <div class="card-body">
                        <ul>
        `;
        details.activities.forEach(activity => {
            html += `<li>${activity}</li>`;
        });
        html += `
                        </ul>
                    </div>
                </div>
        `;
    });
    
    html += `
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-4">
                    <h4><i class="fas fa-chart-line"></i> Assessment Strategies</h4>
                    <ul>
    `;
    data.assessment_strategies.forEach(strategy => {
        html += `<li>${strategy}</li>`;
    });
    html += `
                    </ul>
                </div>
                
                <div class="col-md-6 mb-4">
                    <h4><i class="fas fa-plus-circle"></i> Extension Activities</h4>
                    <ul>
    `;
    data.extension_activities.forEach(activity => {
        html += `<li>${activity}</li>`;
    });
    html += `
                    </ul>
                </div>
            </div>
            
            <div class="mb-4">
                <h4><i class="fas fa-universal-access"></i> Differentiation</h4>
                <ul>
    `;
    data.differentiation.forEach(diff => {
        html += `<li>${diff}</li>`;
    });
    html += `
                </ul>
            </div>
        </div>
    `;
    
    return html;
}

function generateQuizHTML(data) {
    let html = `
        <div class="quiz">
            <div class="mb-4">
                <h2 class="text-success">${data.title}</h2>
                <p class="lead">${data.instructions}</p>
                <p><strong>Total Points:</strong> ${data.total_points}</p>
            </div>
    `;
    
    data.questions.forEach((question, index) => {
        html += `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Question ${index + 1} ${question.points ? `(${question.points} points)` : ''}</h6>
                </div>
                <div class="card-body">
                    <p><strong>${question.question}</strong></p>
        `;
        
        if (question.type === 'multiple_choice') {
            html += '<div class="ms-3">';
            question.options.forEach((option, optIndex) => {
                const isCorrect = optIndex === question.correct_answer;
                html += `<div class="form-check">
                    <input class="form-check-input" type="radio" disabled ${isCorrect ? 'checked' : ''}>
                    <label class="form-check-label ${isCorrect ? 'text-success fw-bold' : ''}">
                        ${String.fromCharCode(65 + optIndex)}. ${option}
                    </label>
                </div>`;
            });
            html += `</div>
                <small class="text-muted"><strong>Answer:</strong> ${question.explanation}</small>`;
        } else if (question.type === 'true_false') {
            html += `
                <div class="ms-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" disabled ${question.correct_answer ? 'checked' : ''}>
                        <label class="form-check-label ${question.correct_answer ? 'text-success fw-bold' : ''}">True</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" disabled ${!question.correct_answer ? 'checked' : ''}>
                        <label class="form-check-label ${!question.correct_answer ? 'text-success fw-bold' : ''}">False</label>
                    </div>
                </div>
                <small class="text-muted"><strong>Answer:</strong> ${question.explanation}</small>
            `;
        } else if (question.type === 'short_answer') {
            html += `
                <div class="ms-3">
                    <textarea class="form-control" rows="3" placeholder="Student answer space..." disabled></textarea>
                </div>
                <small class="text-muted"><strong>Sample Answer:</strong> ${question.sample_answer}</small>
            `;
        } else if (question.type === 'essay') {
            html += `
                <div class="ms-3">
                    <textarea class="form-control" rows="5" placeholder="Student essay space..." disabled></textarea>
                </div>
                <div class="mt-2">
                    <small class="text-muted"><strong>Rubric:</strong></small>
                    <ul class="small text-muted">
            `;
            Object.entries(question.rubric).forEach(([criterion, description]) => {
                html += `<li><strong>${criterion.charAt(0).toUpperCase() + criterion.slice(1)}:</strong> ${description}</li>`;
            });
            html += `
                    </ul>
                </div>
            `;
        }
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

function generateIntroductionHTML(data) {
    let html = `
        <div class="topic-introduction">
            <div class="mb-4">
                <h2 class="text-info">${data.title}</h2>
                <p class="lead">${data.overview}</p>
            </div>
            
            <div class="mb-4">
                <h4><i class="fas fa-lightbulb"></i> What You Will Learn</h4>
                <ul>
    `;
    data.what_you_will_learn.forEach(item => {
        html += `<li>${item}</li>`;
    });
    html += `
                </ul>
            </div>
            
            <div class="mb-4">
                <h4><i class="fas fa-star"></i> Why This Matters</h4>
                <p>${data.why_this_matters}</p>
            </div>
            
            <div class="mb-4">
                <h4><i class="fas fa-book"></i> Key Vocabulary</h4>
                <div class="row">
    `;
    data.key_vocabulary.forEach(term => {
        html += `<div class="col-md-3 mb-2"><span class="badge bg-secondary">${term}</span></div>`;
    });
    html += `
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-4">
                    <h4><i class="fas fa-play"></i> Getting Started</h4>
                    <ol>
    `;
    data.getting_started.forEach(step => {
        html += `<li>${step}</li>`;
    });
    html += `
                    </ol>
                </div>
                
                <div class="col-md-6 mb-4">
                    <h4><i class="fas fa-tips"></i> Learning Tips</h4>
                    <ul>
    `;
    data.learning_tips.forEach(tip => {
        html += `<li>${tip}</li>`;
    });
    html += `
                    </ul>
                </div>
            </div>
            
            <div class="mb-4">
                <h4><i class="fas fa-check-circle"></i> Success Indicators</h4>
                <p>You'll know you're succeeding when:</p>
                <ul>
    `;
    data.success_indicators.forEach(indicator => {
        html += `<li>${indicator}</li>`;
    });
    html += `
                </ul>
            </div>
        </div>
    `;
    
    return html;
}

function generateParentLetterHTML(data) {
    let html = `
        <div class="parent-letter">
            <div class="mb-4">
                <h2 class="text-warning">${data.subject}</h2>
            </div>
            
            <p><strong>${data.greeting}</strong></p>
            <p>${data.introduction}</p>
            
            <div class="mb-4">
                <h4>${data.about_minecraft_education.title}</h4>
                <p>${data.about_minecraft_education.content}</p>
            </div>
            
            <div class="mb-4">
                <h4>${data.learning_benefits.title}</h4>
                <ul>
    `;
    data.learning_benefits.benefits.forEach(benefit => {
        html += `<li>${benefit}</li>`;
    });
    html += `
                </ul>
            </div>
            
            <div class="mb-4">
                <h4>${data.what_to_expect.title}</h4>
                <ul>
    `;
    data.what_to_expect.activities.forEach(activity => {
        html += `<li>${activity}</li>`;
    });
    html += `
                </ul>
            </div>
            
            <div class="mb-4">
                <h4>${data.safety_and_monitoring.title}</h4>
                <p>${data.safety_and_monitoring.content}</p>
            </div>
            
            <div class="mb-4">
                <h4>${data.support_at_home.title}</h4>
                <ul>
    `;
    data.support_at_home.suggestions.forEach(suggestion => {
        html += `<li>${suggestion}</li>`;
    });
    html += `
                </ul>
            </div>
            
            <div class="mb-4">
                <h4>${data.addressing_concerns.title}</h4>
    `;
    data.addressing_concerns.qa.forEach(qa => {
        html += `
                <div class="mb-3">
                    <p><strong>Q: ${qa.question}</strong></p>
                    <p><strong>A:</strong> ${qa.answer}</p>
                </div>
        `;
    });
    html += `
            </div>
            
            <div class="mb-4">
                <h4>${data.contact_information.title}</h4>
                <p>${data.contact_information.content}</p>
            </div>
            
            <p>${data.closing}</p>
            <p style="white-space: pre-line;">${data.signature}</p>
        </div>
    `;
    
    return html;
}

function displayError(errorMessage) {
    const resourceContent = document.getElementById('resourceContent');
    resourceContent.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${errorMessage}
        </div>
    `;
    document.getElementById('resultsArea').style.display = 'block';
}

function copyToClipboard() {
    const content = document.getElementById('resourceContent').innerText;
    navigator.clipboard.writeText(content).then(() => {
        showNotification('Content copied to clipboard!', 'success');
    }).catch(() => {
        showNotification('Failed to copy content', 'error');
    });
}

function downloadResource() {
    if (!currentResourceData || !currentResourceType) return;
    
    const content = document.getElementById('resourceContent').innerText;
    const filename = `${currentResourceType}_${new Date().toISOString().split('T')[0]}.txt`;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showNotification('Resource downloaded!', 'success');
}

function printResource() {
    const printWindow = window.open('', '_blank');
    const content = document.getElementById('resourceContent').innerHTML;
    
    printWindow.document.write(`
        <html>
        <head>
            <title>Educational Resource</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .card { border: 1px solid #dee2e6; margin-bottom: 20px; }
                .card-header { background: #f8f9fa; padding: 10px; font-weight: bold; }
                .card-body { padding: 15px; }
                .text-primary { color: #0d6efd; }
                .text-success { color: #198754; }
                .text-info { color: #0dcaf0; }
                .text-warning { color: #ffc107; }
                .badge { background: #6c757d; color: white; padding: 2px 6px; border-radius: 3px; }
            </style>
        </head>
        <body>
            ${content}
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}
</script>

{% endblock %}